<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CIS 362 Midterm Practive</title>
    <link rel="stylesheet" id="bootstrap" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <style>
    
    </style>
</head>
<body>
    <div class="container">
        <h1>CIS 362 Midterm Practice</h1>
        <h2 id="results" class="text-center d-none"></h2>
        <div id="quiz-setup">
            <div class="row">
                <div class="col-sm-3 offset-3">
                    <label class="float-right">How many questions?</label>
                </div>
                <div class="col-md-3">
                    <input id="question-field" class="form-control" type="number" min="10">
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 offset-sm-6" >
                    <input id="question-range" class="form-control" type="range" value="100">
                </div>
            </div>
            <div class="row" style="margin-top: 5px;">
                <button id="question-submit" type="button" class="btn btn-primary mx-auto my-3">Generate Quiz</button>
            </div>
        </div>
        <div id="quiz" class="d-none">
            <div class="row">
                <form id="quiz-form">
                    
                </form>
            </div>
            <div class="row" style="margin-top: 5px;">
                <button id="quiz-submit" type="button" class="btn btn-primary mx-auto mb-3">Grade Quiz</button>
                <button id="quiz-reset" type="button" class="btn btn-danger mx-auto my-3 d-none">Reset Quiz</button>
            </div>
        </div>
    </div>
</body>
<script src="./data.js"></script>
<script>
    var data = getData(),
    questionField = document.getElementById("question-field"),
    questionRange = document.getElementById("question-range"),
    questionSubmit = document.getElementById("question-submit"),
    quizSubmit = document.getElementById("quiz-submit"),
    quizSetup = document.getElementById("quiz-setup"),
    quizForm = document.getElementById("quiz-form"),
    quizReset = document.getElementById("quiz-reset"),
    quiz = document.getElementById("quiz"),
    results = document.getElementById("results");

    questionField.max = data.length;
    questionField.value = data.length;
    questionRange.min =  (10 / data.length) * 100;

    questionField.addEventListener("change", function(e) {
        if (e.target.value > data.length) {
            e.target.value = data.length;
            questionRange.value = 100;
        }
        else {
            questionRange.value = (e.target.value / data.length) * 100;
        }
    });

    questionRange.addEventListener("input", function(e) {
        questionField.value = Math.round(data.length * (e.target.value * 0.01));
    });

    questionSubmit.addEventListener("click", function() {
        quizSetup.classList.add("d-none");
        quiz.classList.remove("d-none");
        shuffleArray(data);
        for(var i = 0; i <= questionField.value - 1; i++){
            data[i].id = i;
            quizForm.appendChild(createQuestionNode(data[i]));
        }
    });

    quizSubmit.addEventListener("click", function() {
        var regEx = /Q(\d+)/g,
            qId = regEx.exec(quizForm.elements[0].id)[1],
            questionGroup = [],
            correct = 0;

        Array.from(quizForm.elements).forEach(function(input, idx) {
            var regEx = /Q(\d+)/g,
                match = regEx.exec(input.id)[1],
                answer;

            input.parentNode.classList.add("disabled");
            input.disabled = true;

            if (match === qId) {
                questionGroup.push(input);

                if (idx === quizForm.elements.length -1) {
                    answer = questionGroup.filter(function(option) { 
                        return option.value == data[qId].correct;
                    })[0];

                    if (answer.checked) {
                        correct++;
                        answer.parentNode.parentNode.previousElementSibling.style.color = "green";
                    }
                    else {
                        answer.parentNode.parentNode.previousElementSibling.style.color = "red";
                    }

                    answer.nextElementSibling.style.color = "green";
                    answer.nextElementSibling.style.fontWeight = "600";
                    answer.parentNode.classList.remove("disabled");

                    quizReset.classList.remove("d-none");
                    results.classList.remove("d-none");
                    quizSubmit.classList.add("d-none");
                    results.innerHTML = correct + " correct out of " + questionField.value + "<br/>" + Math.round((correct / questionField.value) * 10000) / 100 + "%";
                    window.scrollTo(0,0);
                }
            }
            else {
                answer = questionGroup.filter(function(option) { 
                    return option.value == data[qId].correct;
                })[0];

                if (answer.checked) {
                    correct++;
                    answer.parentNode.parentNode.previousElementSibling.style.color = "green";
                }
                else {
                    answer.parentNode.parentNode.previousElementSibling.style.color = "red";
                }

                answer.nextElementSibling.style.color = "green";
                answer.nextElementSibling.style.fontWeight = "600";
                answer.parentNode.classList.remove("disabled");

                regEx = /Q(\d+)/g;
                qId = regEx.exec(input.id)[1];
                questionGroup = [input];
            }
        });
    });

    quizReset.addEventListener("click", function() {
        while(quizForm.children.length !== 0) {
            quizForm.firstElementChild.remove();
        }

        quizSetup.classList.remove("d-none");
        quizSubmit.classList.remove("d-none");
        quiz.classList.add("d-none");
        results.classList.add("d-none");
        quizReset.classList.add("d-none");
    });

    function createQuestionNode(question) {
        var questionContainer = document.createElement("div"),
            optionContainer = document.createElement("div"),
            questionLabel = document.createElement("label");
        
        questionLabel.innerHTML = "<b>#" + (question.id + 1) + "</b>. " + question.question;

        question.options.forEach(function(option, idx) {
            var formCheck = document.createElement("div"),
                radio = document.createElement("input"),
                radioLabel = document.createElement("label");

            formCheck.classList.add("form-check");

            radio.classList.add("form-check-input");
            radio.type = "radio";
            radio.name = "Q" + question.id;
            radio.id = "Q" + question.id + "-R" + idx;
            radio.value = option;

            radioLabel.classList.add("form-check-label")
            radioLabel.htmlFor = radio.id;
            radioLabel.innerText = option;
            
            formCheck.appendChild(radio);
            formCheck.appendChild(radioLabel);

            formCheck.classList.add("ml-1");

            optionContainer.appendChild(formCheck);
        });

        optionContainer.classList.add("ml-5");
        questionContainer.classList.add("mb-3");

        questionContainer.appendChild(questionLabel);
        questionContainer.appendChild(optionContainer);

        return questionContainer;
    }

    /**
 * Randomize array element order in-place.
 * Using Durstenfeld shuffle algorithm.
 */
function shuffleArray(array) {
    for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var temp = array[i];
        array[i] = array[j];
        array[j] = temp;
    }
}

</script>
</html>